# Deploy CineVault V2 per SSH: Vollrebuild auf dem Server (deploy.sh)
# Wird ausgelöst, wenn der Staging-Workflow erfolgreich durchgelaufen ist (workflow_run).
# Baut auf dem Server mit npm run build – garantiert vollständiges .next/static (Client Components).
# Dauert ~2–5 Min, dafür zuverlässig. deploy.sh kopiert .next/static ins Standalone.
# Secrets: SSH_HOST, SSH_USER, SSH_PORT, SSH_KEY, APP_DIR (optional), DISCORD_STAGING_WEBHOOK

name: Deploy

on:
  workflow_run:
    workflows: ["Staging"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 1

      - name: Deploy via SSH (Vollrebuild, deploy.sh)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          APP_DIR: ${{ secrets.APP_DIR }}
        run: |
          APP_DIR="${APP_DIR:-/opt/CineVaultV2}"
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem
          SSH_OPTS="-i key.pem -p ${SSH_PORT:-22} -o StrictHostKeyChecking=no"
          ssh $SSH_OPTS "$SSH_USER@$SSH_HOST" "cd '$APP_DIR' && git fetch --all --prune && git reset --hard origin/main && chmod +x deploy.sh 2>/dev/null || true && command -v dos2unix >/dev/null 2>&1 && dos2unix -q deploy.sh 2>/dev/null || true; APP_DIR='$APP_DIR' bash ./deploy.sh"

      - name: Discord – Deploy erfolgreich
        if: success()
        env:
          DEPLOY_SUCCESS: "true"
          DISCORD_STAGING_WEBHOOK: ${{ secrets.DISCORD_STAGING_WEBHOOK }}
        run: node scripts/deploy-discord.mjs

      - name: Discord – Deploy fehlgeschlagen
        if: failure()
        env:
          DEPLOY_SUCCESS: "false"
          DISCORD_STAGING_WEBHOOK: ${{ secrets.DISCORD_STAGING_WEBHOOK }}
        run: node scripts/deploy-discord.mjs
