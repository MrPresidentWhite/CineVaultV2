# Notfall: Vollständiger Rebuild auf dem Server (ohne Artifact).
# Erstellt .next/static lokal auf dem Server – löst das Problem fehlender Client Components.
# Dauert länger (~2–5 Min) als Artifact-Deploy, aber garantiert vollständigen Build.
#
# Auslösen: Actions → "Deploy Full Rebuild" → "Run workflow"
# Voraussetzung: Vorheriger Push auf main, damit der Server den Code hat.
# Secrets: SSH_HOST, SSH_USER, SSH_PORT, SSH_KEY, APP_DIR, DISCORD_STAGING_WEBHOOK

name: Deploy Full Rebuild

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Deploy via SSH (Vollrebuild, kein Artifact)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          APP_DIR: ${{ secrets.APP_DIR }}
        run: |
          APP_DIR="${APP_DIR:-/opt/CineVaultV2}"
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem
          SSH_OPTS="-i key.pem -p ${SSH_PORT:-22} -o StrictHostKeyChecking=no"
          ssh $SSH_OPTS "$SSH_USER@$SSH_HOST" "cd '$APP_DIR' && git fetch --all --prune && git reset --hard origin/main && chmod +x deploy.sh 2>/dev/null || true && command -v dos2unix >/dev/null 2>&1 && dos2unix -q deploy.sh 2>/dev/null || true; APP_DIR='$APP_DIR' bash ./deploy.sh"
          echo "Deploy abgeschlossen. .next/static wurde auf dem Server erstellt."

      - name: Discord – Deploy erfolgreich
        if: success()
        env:
          DEPLOY_SUCCESS: "true"
          DISCORD_STAGING_WEBHOOK: ${{ secrets.DISCORD_STAGING_WEBHOOK }}
        run: node scripts/deploy-discord.mjs

      - name: Discord – Deploy fehlgeschlagen
        if: failure()
        env:
          DEPLOY_SUCCESS: "false"
          DISCORD_STAGING_WEBHOOK: ${{ secrets.DISCORD_STAGING_WEBHOOK }}
        run: node scripts/deploy-discord.mjs
