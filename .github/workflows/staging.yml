# Staging: Lint, Tests, Build → Staging-Report (Grok + Discord) → bei Erfolg wird Deploy getriggert
# Läuft bei Push auf main. Deploy-Workflow startet nur, wenn Staging erfolgreich durchläuft.
# Secrets: DISCORD_STAGING_WEBHOOK, GROK_API_URL, GROK_API_KEY, GROK_API_MODEL

name: Staging

on:
  push:
    branches: [main]

jobs:
  staging:
    runs-on: ubuntu-latest
    env:
      # Nur für CI-Build: src/lib/env.ts verlangt in Prod SESSION_SECRET und getDatabaseUrl() DB-Config.
      # Echte Prod nutzt Secrets aus der Server-.env; hier reichen Platzhalter (kein echter DB-Zugriff).
      SESSION_SECRET: "ci-build-placeholder-not-used-at-runtime"
      DATABASE_URL: "postgresql://ci:ci@localhost:5432/ci"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Prisma generate
        run: npm run db:generate

      - name: Lint
        id: lint
        continue-on-error: true
        run: |
          npm run lint 2>&1 | tee lint.txt
          exit ${PIPESTATUS[0]}

      - name: Test
        id: test
        continue-on-error: true
        run: |
          npm test 2>&1 | tee test.txt
          exit ${PIPESTATUS[0]}

      - name: Build
        id: build
        run: |
          npm run build 2>&1 | tee build.txt
          exit ${PIPESTATUS[0]}

      - name: Logging-Check (keine Secrets in Logs, v2 Abschnitt 15.3)
        id: logging-check
        continue-on-error: true
        run: node scripts/staging-logging-check.mjs logging-check.txt || exit 1

      - name: Staging-Report an Discord (mit Grok)
        if: always()
        env:
          LINT_OUTCOME: ${{ steps.lint.outcome }}
          TEST_OUTCOME: ${{ steps.test.outcome }}
          BUILD_OUTCOME: ${{ steps.build.outcome }}
          LOGGING_CHECK_OUTCOME: ${{ steps.logging-check.outcome }}
          DISCORD_STAGING_WEBHOOK: ${{ secrets.DISCORD_STAGING_WEBHOOK }}
          GROK_API_URL: ${{ secrets.GROK_API_URL }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GROK_API_MODEL: ${{ secrets.GROK_API_MODEL }}
        run: node scripts/staging-report-discord.mjs lint.txt test.txt build.txt logging-check.txt

      - name: Staging fehlgeschlagen
        if: always() && (steps.lint.outcome == 'failure' || steps.test.outcome == 'failure' || steps.build.outcome == 'failure' || steps.logging-check.outcome == 'failure')
        run: |
          echo "Mindestens ein Check (Lint/Tests/Build/Logging-Check) ist fehlgeschlagen. Kein Deployment."
          exit 1
